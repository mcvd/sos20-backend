name: Build and Deploy to GKE

on:
  push:
    branches:
    - master

env:
  GKE_PROJECT: ${{ secrets.GKE_PROJECT }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GITHUB_SHA: ${{ github.sha }}
  IMAGE_NAME: sos20-backend
  DOCKER_BUILDKIT: 1

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
        
      - name: Login to GitHub Registry
        run: docker login docker.pkg.github.com -u owner -p ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build image
        run: docker build -t ${IMAGE_NAME}:${GITHUB_SHA} -t docker.pkg.github.com/${{ github.repository }}/${IMAGE_NAME}:${GITHUB_SHA} --file Dockerfile .
      
      - name: Push image to GitHub Registry
        run: docker push docker.pkg.github.com/${{ github.repository }}/${IMAGE_NAME}:${GITHUB_SHA}
  
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
        
      - name: Setup gcloud
        uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
        with:
          version: '270.0.0'
          service_account_email: ${{ secrets.GCP_EMAIL }}
          service_account_key: ${{ secrets.GCP_KEY }}
          
      - name: Deploy
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE --project $GKE_PROJECT
          sed -i -e "s/<IMAGE>/${IMAGE_NAME}:${GITHUB_SHA}/" nginx.yml
          kubectl apply -f kube.yml
          kubectl get pods -o yaml
    
